---
title: "03-04ROC_PRC_Training-Test"
output: html_document
date: "2024-10-19"
---

```{r}
library(ggplot2)
library(precrec)
library(pROC)
```

```{r}
# 画ROC和PRC曲线
draw_ROC_PRC <- function(data){
  scores1 <- join_scores(data$RF16_prob, data$RF11_prob, data$TMB);
  msmdat <- mmdata(scores1, data$Response);
  msmdat2 <- mmdata(
    scores1, data$Response, 
    modnames = c("RF16", "RF11", "TMB")
  );
  mscurves <- evalmod(msmdat2);
  print(autoplot(mscurves));
  print(mscurves);
}
# 计算最佳阈值
get_optimal_threshold <- function(data){
  prob_roc <- roc(data$Response, data$RF16_prob);
  par(pty = "s");
  plot.roc(
    prob_roc, 
    col = "red", 
    print.auc = TRUE, print.auc.adj = c(2,-12),
    max.auc.polygon = TRUE, 
    print.thres = TRUE, print.thres.pch = 19, print.thres.col = "red", print.thres.adj = c(0.3,-1.2),
    auc.polygon = TRUE, auc.polygon.col = "#D1F2EB",
    legacy.axes = TRUE
  );
  legend("bottomright", legend = c("RF16"), col = c("red"), lwd = 2);
  pan_threshold <- ci.thresholds(prob_roc, thresholds = "best");
  return(pan_threshold);
}
# 将最佳阈值写入
write_optimal_threshold <- function(pan_threshold, cancer_type, file_path){
  cat(paste(cancer_type, "Threshold", sep = " "), file = file_path, append = TRUE);
  capture.output(pan_threshold, file = file_path, append = TRUE);
  # 注：capture.output函数必须在终端中运行才可正常工作，在rmd中运行只能输出第一行内容
}
# 训练组
training_func <- function(data, cancer_type = "Pan-cancer", file_path = "Pan_Thresholds.txt"){
  draw_ROC_PRC(data);
  write_optimal_threshold(
    get_optimal_threshold(data),
    cancer_type,
    file_path
  );
}
```
**训练组**：（如果想得到完整的txt文件，就在终端中运行该段代码，因为`capture.output`函数必须在终端中运行才可正常工作）
```{r}
data <- read.table('../pycharm/Training_RF_Prob.txt', header = T, sep = '\t');
# 泛癌
training_func(data);
# Melanoma
data_Melanoma <- data[grep("0", data$Cancer_Type), ];
training_func(data_Melanoma, "Melanoma", "Thresholds.txt");
# NSCLC
data_NSCLC <- data[grep("1", data$Cancer_Type), ];
training_func(data_NSCLC, "NSCLC", "Thresholds.txt");
# 其它
data_NSCLC <- data[grep("2", data$Cancer_Type), ];
training_func(data_NSCLC, "Others", "Thresholds.txt");
```
**验证组**：
```{r}
data <- read.table('../pycharm/Test_RF_Prob.txt', header = T, sep = '\t');
# 泛癌
draw_ROC_PRC(data);
# Melanoma
data_Melanoma <- data[grep("0", data$Cancer_Type), ];
draw_ROC_PRC(data_Melanoma);
# NSCLC
data_NSCLC <- data[grep("1", data$Cancer_Type), ];
draw_ROC_PRC(data_NSCLC);
# 其它
data_NSCLC <- data[grep("2", data$Cancer_Type), ];
draw_ROC_PRC(data_NSCLC);
```

