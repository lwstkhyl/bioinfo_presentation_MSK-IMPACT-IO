---
title: "03-04ROC_PRC_Training-Test"
output: html_document
date: "2024-10-19"
---

```{r}
library(ggplot2);
library(precrec);
library(pROC);
library(patchwork);
```

```{r}
# 画ROC和PRC曲线
draw_ROC_PRC <- function(data, cancer_type = ""){
  scores1 <- join_scores(data$RF16_prob, data$RF11_prob, data$TMB);
  msmdat <- mmdata(scores1, data$Response);
  msmdat2 <- mmdata(
    scores1, data$Response, 
    modnames = c("RF16", "RF11", "TMB")
  );
  mscurves <- evalmod(msmdat2);
  all_pic <- autoplot(mscurves);  # 原始图
  # 给图加标题（癌症种类）
  p1 <- all_pic[[1]] + theme(legend.position = "none");
  p2 <- all_pic[[2]];
  all_pic_new <- (p1 + p2) + 
    plot_annotation(title = cancer_type) &
    theme(plot.title = element_text(hjust = 0.5));
  print(all_pic_new);
  # 分界线、曲线具体数值
  if(cancer_type!="") cancer_type <- paste0(" ", cancer_type, " ");
  print(paste0("|----------", cancer_type, "----------|"));
  print(mscurves);
  print(paste0("|----------", paste(replicate(nchar(cancer_type), "-"), collapse = ""), "----------|"));
}
# 计算最佳阈值
get_optimal_threshold <- function(data){
  prob_roc <- roc(data$Response, data$RF16_prob);
  par(pty = "s");
  plot.roc(
    prob_roc, 
    col = "red", 
    print.auc = TRUE, print.auc.adj = c(2,-12),
    max.auc.polygon = TRUE, 
    print.thres = TRUE, print.thres.pch = 19, print.thres.col = "red", print.thres.adj = c(0.3,-1.2),
    auc.polygon = TRUE, auc.polygon.col = "#D1F2EB",
    legacy.axes = TRUE
  );
  # legend("bottomright", legend = c("RF16"), col = c("red"), lwd = 2);
  title("RF16");
  pan_threshold <- ci.thresholds(prob_roc, thresholds = "best");
  return(pan_threshold);
}
# 将最佳阈值写入
write_optimal_threshold <- function(pan_threshold, cancer_type, file_path){
  cat(paste(cancer_type, "Threshold", sep = " "), file = file_path, append = TRUE);
  capture.output(pan_threshold, file = file_path, append = TRUE);
  # 注：capture.output函数必须在终端中运行才可正常工作，在rmd中运行只能输出第一行内容
}
# 训练组
training_func <- function(data, cancer_type = "Pan-cancer", file_path = "data/Pan_data/Thresholds.txt"){
  draw_ROC_PRC(data, cancer_type);
  write_optimal_threshold(
    get_optimal_threshold(data),
    cancer_type,
    file_path
  );
}
```
**训练组**：（如果想得到完整的txt文件，就在终端中运行该段代码，因为`capture.output`函数必须在终端中运行才可正常工作）
```{r}
data <- read.table('../pycharm/data/Training_RF_Prob.txt', header = T, sep = '\t');
# 泛癌
training_func(data);
# Melanoma
data_Melanoma <- data[grep("0", data$Cancer_Type), ];
training_func(data_Melanoma, "Melanoma", "data/Thresholds.txt");
# NSCLC
data_NSCLC <- data[grep("1", data$Cancer_Type), ];
training_func(data_NSCLC, "NSCLC", "data/Thresholds.txt");
# 其它
data_NSCLC <- data[grep("2", data$Cancer_Type), ];
training_func(data_NSCLC, "Others", "data/Thresholds.txt");
```
**验证组**：
```{r}
data <- read.table('../pycharm/data/Test_RF_Prob.txt', header = T, sep = '\t');
# 泛癌
draw_ROC_PRC(data, "Pan-cancer");
# Melanoma
data_Melanoma <- data[grep("0", data$Cancer_Type), ];
draw_ROC_PRC(data_Melanoma, "Melanoma");
# NSCLC
data_NSCLC <- data[grep("1", data$Cancer_Type), ];
draw_ROC_PRC(data_NSCLC, "NSCLC");
# 其它
data_NSCLC <- data[grep("2", data$Cancer_Type), ];
draw_ROC_PRC(data_NSCLC, "Others");
```
```{r}
p1new <- p[[1]]+theme( legend.position =" none ")
p2 <- p1new+p[[2]]
print(p2)
print(p)
```

